<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>実験2: デバイス環境比較実験</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7/dist/aframe-extras.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; overflow: hidden; transition: background-color 0.1s; }
        
        /* 2D用UI (Ex27のデザイン) */
        #ui-2d {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #808080; color: #eee;
            padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 100; display: none; text-align: center;
            min-width: 350px;
        }
        
        #h-slider-2d {
            -webkit-appearance: none; appearance: none;
            width: 300px; height: 20px; border-radius: 10px;
            outline: none; margin: 10px 0; border: 1px solid #ccc;
            background: linear-gradient(to right, hsl(0,100%,50%), hsl(60,100%,50%), hsl(120,100%,50%), hsl(180,100%,50%), hsl(240,100%,50%), hsl(300,100%,50%), hsl(360,100%,50%));
        }
        #h-slider-2d::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 24px; height: 24px; border-radius: 50%;
            background: #ffffff; border: 2px solid #333;
            cursor: pointer; box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(128, 128, 128, 0.95); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #fff;
        }
        #setup-screen { background: #666; padding: 30px; border-radius: 10px; color: #fff; }
        .hidden { display: none !important; }
        
        canvas { border: 1px solid #ccc; cursor: crosshair; margin-bottom: 10px; border-radius: 4px; }
        button {
            padding: 12px 24px; font-size: 16px; font-weight: bold; cursor: pointer;
            border: 1px solid #999; border-radius: 6px; margin-top: 15px; width: 100%;
            transition: background-color 0.2s, color 0.2s;
            background-color: #E0E0E0; color: #333;
        }
        button:hover { background-color: #fff; }
        button.active { background-color: #404040; color: #fff; border: 1px solid #000; }
        
        input, select { padding: 10px; font-size: 16px; margin: 10px; }
        #vr-scene-container { width: 100vw; height: 100vh; display: none; }
    </style>
</head>
<body>

    <div id="overlay">
        <div id="setup-screen" style="text-align:center;">
            <h2>実験2: 設定</h2>
            <p>参加者ID: <input type="text" id="participant-id" value="test_user" style="color:#000;"></p>
            <p>実験条件: 
                <select id="condition-select" style="color:#000;">
                    <option value="1">条件1: 2D・ピッカーのみ</option>
                    <option value="2">条件2: 2D・全画面</option>
                    <option value="3">条件3: VR・ピッカー+床</option>
                    <option value="4">条件4: VR・空間全体+床</option>
                </select>
            </p>
            <p>音声ファイル数: <span id="audio-count">未ロード</span></p>
            
            <div style="margin-top: 20px; padding: 20px; border: 1px solid #999; border-radius: 8px; background: #555;">
                <strong>テストページ</strong><br>
                <button onclick="startPractice()" style="width:auto; margin-top:10px;">練習・音量テストを開始</button>
            </div>
            <br>
            <button onclick="startExperiment()" style="width:auto;">本番を開始する</button>
        </div>

        <div id="download-screen" class="hidden" style="text-align:center; background:#666; padding:30px; border-radius:10px;">
            <h2>実験終了</h2>
            <p>お疲れ様でした。データを保存してください。</p>
            <button onclick="downloadCSV()">結果をダウンロード (CSV)</button>
            <br><br>
            <button onclick="location.reload()" style="background:#444; color:#ccc;">トップに戻る</button>
        </div>
    </div>

    <audio id="audio-player"></audio>
    
    <canvas id="canvas-trial-vr" width="512" height="128" style="display:none;"></canvas>
    <canvas id="canvas-inst-vr" width="512" height="128" style="display:none;"></canvas>
    <canvas id="canvas-play-vr" width="512" height="128" style="display:none;"></canvas>
    <canvas id="canvas-confirm-vr" width="512" height="128" style="display:none;"></canvas>

    <div id="ui-2d">
        <h3 id="trial-info-2d" style="margin-top:0;">Trial 1</h3>
        <p id="instruction-2d">音を聴いて、想起する色を選んでください</p>
        
        <button onclick="handlePlayButton()" id="btn-play-2d">再生 (Play)</button>
        
        <div id="controls-2d" style="margin-top:20px; display:none;">
            <canvas id="sv-canvas-2d" width="300" height="200"></canvas><br>
            <input type="range" id="h-slider-2d" min="0" max="360" value="0" style="width:300px;">
            
            <div style="margin: 10px auto; width: 300px;">
                <p style="margin: 0 0 5px 0; font-size: 14px; color: #eee; text-align: left;">色のプレビュー</p>
                <div id="preview-2d" style="width: 100%; height: 60px; border: 1px solid #eee; border-radius: 5px;"></div>
            </div>
            
            <button onclick="confirmColor()">決定して次へ</button>
        </div>

        <button id="btn-end-practice-2d" onclick="endPractice()" style="display:none; background-color:#d32f2f; color:white; margin-top:20px;">練習を終了して戻る</button>
    </div>

    <div id="vr-scene-container">
        <canvas id="sv-canvas-vr" width="256" height="256" style="display:none;"></canvas>
        <canvas id="h-canvas-vr" width="256" height="64" style="display:none;"></canvas>

        <a-scene id="aframe-scene" embedded>
            <a-sphere id="env-sphere" radius="50" material="shader:flat; color:#808080; side:back" visible="false"></a-sphere>
            <a-grid id="env-grid" width="20" height="20" divisions="20" material="shader:flat; color:#404040" position="0 0.01 0"></a-grid>

            <a-entity id="control-panel" position="0 1.3 -2.5" rotation="-15 0 0" color-picker-panel>
                <a-plane position="0 0.05 -0.01" width="1.2" height="2.9" material="shader:flat; color:#808080"></a-plane>
                
                <a-plane id="info-plane-vr" position="0 1.25 0" width="1.0" height="0.2" 
                         material="shader:flat; src:#canvas-trial-vr; transparent:true"></a-plane>
                
                <a-text id="vr-message" value="" align="center" width="2" position="0 1.05 0.05" color="#FFFF00"
                        font="https://cdn.jsdelivr.net/gh/etiennepinchon/aframe-fonts/fonts/mplus1p/mplus1p-regular.json" shader="msdf"></a-text>
                
                <a-plane id="btn-play-vr" position="0 0.85 0" width="0.8" height="0.2" 
                         material="shader:flat; src:#canvas-play-vr" 
                         class="clickable" onclick="handlePlayButton()"></a-plane>

                <a-plane id="inst-plane-vr" position="0 0.6 0" width="1.0" height="0.2" 
                         material="shader:flat; src:#canvas-inst-vr; transparent:true"></a-plane>

                <a-entity id="controls-vr" visible="false">
                    <a-plane id="sv-plane" class="clickable" position="0 0.05 0" width="0.8" height="0.8" material="shader:flat; src:#sv-canvas-vr"></a-plane>
                    <a-sphere id="sv-cursor" position="0 0.05 0.01" radius="0.02" material="shader:flat; color:#FFF" visible="false"></a-sphere>

                    <a-plane id="h-plane" class="clickable" position="0 -0.45 0" width="0.8" height="0.15" material="shader:flat; src:#h-canvas-vr"></a-plane>
                    <a-plane id="h-cursor" position="0 -0.45 0.01" width="0.02" height="0.17" material="shader:flat; color:#FFF; opacity:0.8" visible="false"></a-plane>

                    <a-text value="Preview:" width="3" position="-0.4 -0.6 0" color="#ccc"
                            font="https://cdn.jsdelivr.net/gh/etiennepinchon/aframe-fonts/fonts/mplus1p/mplus1p-regular.json" shader="msdf"></a-text>
                    
                    <a-plane id="vr-preview" position="0 -0.75 0" width="0.8" height="0.2" material="shader:flat; color:#808080; border-color:#eee"></a-plane>
                    <a-plane position="0 -0.75 -0.005" width="0.82" height="0.22" material="shader:flat; color:#ccc"></a-plane>

                    <a-plane id="btn-confirm-vr" position="0 -1.0 0" width="0.8" height="0.2" 
                             material="shader:flat; src:#canvas-confirm-vr" 
                             class="clickable" onclick="confirmColor()"></a-plane>
                </a-entity>
            </a-entity>

            <a-entity id="player" position="0 0 0">
                <a-camera id="camera" look-controls="enabled: true"></a-camera>
                <a-entity laser-controls="hand: right" raycaster="objects: .clickable; far: 5" line="color: red; opacity: 0.75"></a-entity>
            </a-entity>
        </a-scene>
    </div>

    <script>
        // --- 設定エリア ---
        const AUDIO_FILES = [
            "音刺激 カデンツ1 ハ長調.mp3",
            "音刺激 曲フレーズ ジムノペディ.mp3",
            "音刺激 単音 piano C4.mp3",
            "音刺激 単音 ヴァイオリン C4.mp3"
        ];
        
        const PRACTICE_AUDIO = "practice.wav";
        const GAS_URL ="https://script.google.com/macros/s/AKfycbwO-b3LMxtAIAf3p-cZbfWNehT56fc5lRnAUJb4dct9eAzdLJWSzXxi20Dgw9YUAEA/exec";
        // ----------------

        let currentTrialIdx = 0;
        let participantId = "";
        let conditionId = "1";
        let results = [];
        let startTime = 0;
        let isAudioPlayed = false;
        let isPracticeMode = false;
        let msgTimeout = null;
        let audioState = 'initial'; 
        let currentH = 0, currentS = 0, currentV = 50; 

        // ログ用
        let playCount = 0;
        let operationCount = 0;

        let experimentPlaylist = [];

        const ui2d = document.getElementById('ui-2d');
        const vrContainer = document.getElementById('vr-scene-container');
        const audioPlayer = document.getElementById('audio-player');
        
        document.getElementById('audio-count').innerText = (AUDIO_FILES.length * 2) + "ファイル (各2回)";

        audioPlayer.addEventListener('timeupdate', function() {
            if (!isAudioPlayed && audioPlayer.duration > 0 && (audioPlayer.duration - audioPlayer.currentTime <= 3.0)) {
                isAudioPlayed = true;
                startTime = Date.now();
                showMessage(""); 
                document.getElementById('controls-2d').style.display = 'block';
                const vrControls = document.getElementById('controls-vr');
                if(vrControls) vrControls.setAttribute('visible', true);
                audioState = 'ready_to_loop';
                updateButtonState();
            }
        });

        // 2D初期化関数（Ex27仕様：ポインタなし、即時反映）
        function init2DCanvas() {
            const canvas = document.getElementById('sv-canvas-2d');
            const slider = document.getElementById('h-slider-2d');
            const ctx = canvas.getContext('2d');
            
            // 重複イベント登録を防ぐため、一度だけ登録する
            if (canvas.getAttribute('data-ready') === 'true') {
                draw2DGradient();
                return;
            }
            canvas.setAttribute('data-ready', 'true');

            function draw2DGradient() {
                const w = canvas.width, h = canvas.height;
                // 色相背景
                ctx.fillStyle = `hsl(${slider.value}, 100%, 50%)`; 
                ctx.fillRect(0,0,w,h);
                // 白黒グラデーション
                const wg = ctx.createLinearGradient(0,0,w,0);
                wg.addColorStop(0,'white'); wg.addColorStop(1,'rgba(255,255,255,0)');
                ctx.fillStyle = wg; ctx.fillRect(0,0,w,h);
                const bg = ctx.createLinearGradient(0,0,0,h);
                bg.addColorStop(0,'rgba(0,0,0,0)'); bg.addColorStop(1,'black');
                ctx.fillStyle = bg; ctx.fillRect(0,0,w,h);
            }

            // スライダーイベント
            slider.addEventListener('input', () => { 
                if(isAudioPlayed) operationCount++;
                // Hのみ更新。S,Vは現在の値を維持
                updateColor(slider.value, currentS, currentV); 
                draw2DGradient(); // 背景色を更新
            });

            // Canvasイベント (マウス操作)
            let isDragging = false;
            const updateFromCanvas = (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
                const y = Math.max(0, Math.min(e.clientY - rect.top, rect.height));
                
                // S, Vを計算して更新
                const s = Math.round((x / rect.width) * 100);
                const v = Math.round((1 - y / rect.height) * 100);
                
                if(isAudioPlayed) operationCount++;
                updateColor(slider.value, s, v); 
            };

            canvas.addEventListener('mousedown', (e) => { isDragging = true; updateFromCanvas(e); });
            window.addEventListener('mousemove', (e) => { if(isDragging) updateFromCanvas(e); });
            window.addEventListener('mouseup', () => { isDragging = false; });
            
            draw2DGradient();
        }

        function startPractice() {
            participantId = document.getElementById('participant-id').value;
            conditionId = document.getElementById('condition-select').value;
            isPracticeMode = true;

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('overlay').classList.add('hidden');

            setupConditionView(conditionId);
            currentTrialIdx = -1; 
            
            const infoText = "Practice Mode";
            document.getElementById('trial-info-2d').innerText = infoText;
            document.getElementById('instruction-2d').innerText = "音量を調整し、操作を確認してください";
            
            drawCanvasText('canvas-trial-vr', 'info-plane-vr', "Practice Mode", "#808080", "#FFFFFF", 40);

            audioPlayer.src = "audio/" + PRACTICE_AUDIO;
            resetTrialState();
            
            showMessage("Adjust Volume & Practice");
            document.getElementById('btn-end-practice-2d').style.display = 'inline-block';
        }

        function endPractice() {
            if(audioState === 'looping') stopLooping();
            
            document.getElementById('ui-2d').style.display = 'none';
            document.getElementById('vr-scene-container').style.display = 'none';
            document.body.style.backgroundColor = "#FFFFFF"; 
            
            document.getElementById('overlay').classList.remove('hidden');
            document.getElementById('setup-screen').classList.remove('hidden');
            
            isPracticeMode = false;
        }

        function startExperiment() {
            participantId = document.getElementById('participant-id').value;
            conditionId = document.getElementById('condition-select').value;
            isPracticeMode = false;
            
            if(!participantId) { alert("参加者IDを入力してください"); return; }
            
            createExperimentPlaylist();

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('overlay').classList.add('hidden');
            
            document.getElementById('instruction-2d').innerText = "音を聴いて、想起する色を選んでください";
            
            setupConditionView(conditionId);
            loadTrial(0);

            document.getElementById('btn-end-practice-2d').style.display = 'none';
        }

        function createExperimentPlaylist() {
            let list = AUDIO_FILES.concat(AUDIO_FILES);
            let isValid = false;
            while (!isValid) {
                shuffleArray(list);
                isValid = true;
                for (let i = 1; i < list.length; i++) {
                    if (list[i] === list[i-1]) {
                        isValid = false;
                        break;
                    }
                }
            }
            experimentPlaylist = list;
            console.log("Playlist generated:", experimentPlaylist);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function setupConditionView(cond) {
            ui2d.style.display = 'none';
            vrContainer.style.display = 'none';
            document.body.style.backgroundColor = "#808080"; 
            
            if (cond === "1" || cond === "2") {
                ui2d.style.display = 'block';
                // 2D初期化を確実に実行
                setTimeout(init2DCanvas, 100); 
            } else {
                vrContainer.style.display = 'block';
                const sphere = document.getElementById('env-sphere');
                sphere.setAttribute('visible', true);
                const initialColor = hsvToHslCss(0, 0, 50); 
                sphere.setAttribute('material', 'color', initialColor); 
                const grid = document.getElementById('env-grid');
                if(grid) grid.setAttribute('material', 'color', '#404040');
            }
        }

        function loadTrial(index) {
            if (index >= experimentPlaylist.length) {
                finishExperiment();
                return;
            }
            currentTrialIdx = index;
            
            const trialText = `Trial ${index + 1} / ${experimentPlaylist.length}`;
            const audioName = experimentPlaylist[index];
            
            document.getElementById('trial-info-2d').innerText = trialText;
            drawCanvasText('canvas-trial-vr', 'info-plane-vr', trialText, "#808080", "#FFFFFF", 50);

            audioPlayer.src = "audio/" + audioName; 
            
            resetTrialState();
            console.log(`Trial ${index+1} loaded: ${audioName}`);
        }

        function resetTrialState() {
            playCount = 0; operationCount = 0;
            currentH = 0; currentS = 0; currentV = 50;
            isAudioPlayed = false;
            audioState = 'initial'; 
            
            updateColor(currentH, currentS, currentV);
            updateButtonState(); 

            document.getElementById('controls-2d').style.display = 'none';
            const vrControls = document.getElementById('controls-vr');
            if(vrControls) vrControls.setAttribute('visible', false);
            
            const slider = document.getElementById('h-slider-2d');
            if(slider) slider.value = 0;
            
            // 2Dリセット：描画を初期状態に戻す（ただしイベントはそのまま）
            if (conditionId === "1" || conditionId === "2") {
                setTimeout(init2DCanvas, 50);
            }
        }

        function handlePlayButton() {
            playCount++;
            if (audioState === 'initial') {
                playFirstTime();
            } else if (audioState === 'ready_to_loop') {
                startLooping();
            } else if (audioState === 'looping') {
                stopLooping();
            }
        }

        function playFirstTime() {
            audioPlayer.loop = false;
            audioPlayer.currentTime = 0;
            audioPlayer.play().then(() => {
                showMessage("Listening...");
            }).catch(e => showMessage("Error: Audio not found"));
        }

        function startLooping() {
            audioPlayer.loop = true;
            audioPlayer.currentTime = 0; 
            audioPlayer.play();
            audioState = 'looping';
            updateButtonState();
        }

        function stopLooping() {
            audioPlayer.pause();
            audioPlayer.currentTime = 0; 
            audioState = 'ready_to_loop';
            updateButtonState();
        }

        function drawCanvasText(canvasId, elementId, text, bgColor, textColor, fontSize = 60) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = bgColor; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = textColor; ctx.font = `bold ${fontSize}px sans-serif`;
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);

            const btnEl = document.getElementById(elementId);
            if (btnEl) {
                const mesh = btnEl.getObject3D('mesh');
                if (mesh && mesh.material && mesh.material.map) mesh.material.map.needsUpdate = true;
            }
        }
        
        function drawInstructionCanvas() {
            const canvas = document.getElementById('canvas-inst-vr');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "#808080"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#FFFFFF"; ctx.font = "bold 35px sans-serif";
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText("音を聴いて、", canvas.width / 2, 40);
            ctx.fillText("想起する色を選んでください", canvas.width / 2, 90);
            
            const btnEl = document.getElementById('inst-plane-vr');
            if (btnEl) {
                const mesh = btnEl.getObject3D('mesh');
                if (mesh && mesh.material && mesh.material.map) mesh.material.map.needsUpdate = true;
            }
        }
        
        function drawCanvasButton(canvasId, elementId, text, bgColor, textColor) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = bgColor; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = textColor; ctx.lineWidth = 10; ctx.strokeRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = textColor; ctx.font = "bold 60px sans-serif"; 
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);

            const btnEl = document.getElementById(elementId);
            if (btnEl) {
                const mesh = btnEl.getObject3D('mesh');
                if (mesh && mesh.material && mesh.material.map) mesh.material.map.needsUpdate = true;
            }
        }

        function updateButtonState() {
            const btn2d = document.getElementById('btn-play-2d');
            let text = "再生 (Play)";
            let vrBgColor = "#E0E0E0"; 
            let vrTextColor = "#333";
            let cssClass = "";

            if (audioState === 'initial') {
                text = "再生 (Play)";
            } else if (audioState === 'ready_to_loop') {
                text = "ループ開始 (Loop)";
            } else if (audioState === 'looping') {
                text = "停止 (Stop)";
                vrBgColor = "#d32f2f"; 
                vrTextColor = "#FFF"; 
                cssClass = "active";
            }

            if(btn2d) { btn2d.innerText = text; btn2d.className = cssClass; }
            drawCanvasButton('canvas-play-vr', 'btn-play-vr', text, vrBgColor, vrTextColor);
        }

        window.addEventListener('load', function() {
            drawCanvasButton('canvas-confirm-vr', 'btn-confirm-vr', '決定して次へ', '#E0E0E0', '#333');
            drawInstructionCanvas();
            updateButtonState();
        });

        function showMessage(text) {
            console.log("Message:", text);
            if (msgTimeout) clearTimeout(msgTimeout);
            if (conditionId === "3" || conditionId === "4") {
                const msgEl = document.getElementById('vr-message');
                if (msgEl) {
                    msgEl.setAttribute('value', text);
                    if(text !== "Listening..." && text !== "" && text.indexOf("Finished") === -1) {
                        msgTimeout = setTimeout(() => { msgEl.setAttribute('value', ""); }, 3000);
                    }
                }
            }
        }

        function confirmColor() {
            if (!isAudioPlayed) { showMessage("Please play sound first!"); return; }
            if(audioState === 'looping') stopLooping();

            if (isPracticeMode) {
                showMessage("Practice Trial Done. Try again.");
                resetTrialState();
                return;
            }

            const rt = Date.now() - startTime;
            const hsl = hsvToHslCss(currentH, currentS, currentV);
            
            const record = {
                participant_id: participantId,
                condition: conditionId,
                trial_number: currentTrialIdx + 1,
                audio_file: experimentPlaylist[currentTrialIdx], 
                h: currentH, s: currentS, v: currentV,
                hsl_css: hsl,
                reaction_time_ms: rt,
                play_count: playCount,
                operation_count: operationCount,
                user_agent: navigator.userAgent,
                timestamp: new Date().toISOString()
            };
            
            sendToGoogleSheets(record);
            showMessage("Recorded! Next trial...");
            results.push(record);
            loadTrial(currentTrialIdx + 1);
        }

        function sendToGoogleSheets(data) {
            fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(data)
            }).then(() => { console.log("Data sent"); }).catch(err => { console.error("Failed", err); });
        }

        function finishExperiment() {
            document.getElementById('overlay').classList.remove('hidden');
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('download-screen').classList.remove('hidden');
            
            const vrContainer = document.getElementById('vr-scene-container');
            if (vrContainer.style.display !== 'none') {
                if (msgTimeout) clearTimeout(msgTimeout);
                const msgEl = document.getElementById('vr-message');
                if(msgEl) {
                    msgEl.setAttribute('value', "Experiment Finished\nPlease take off HMD");
                    msgEl.setAttribute('color', "#00FF00"); 
                    msgEl.setAttribute('scale', "1.5 1.5 1.5");
                    msgEl.setAttribute('position', "0 1.6 0.05"); 
                }
                const vrControls = document.getElementById('controls-vr');
                if(vrControls) vrControls.setAttribute('visible', false);
                document.getElementById('btn-play-vr').setAttribute('visible', false);
            } else { vrContainer.style.display = 'none'; }
        }

        function downloadCSV() {
            if (results.length === 0) return;
            const headers = Object.keys(results[0]).join(",");
            const rows = results.map(r => Object.values(r).join(","));
            const csvContent = headers + "\n" + rows.join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `exp2_${participantId}_cond${conditionId}.csv`; a.click();
        }

        function updateColor(h, s, v) {
            currentH = parseInt(h); currentS = parseInt(s); currentV = parseInt(v);
            const cssColor = hsvToHslCss(h, s, v);

            // 2Dプレビュー更新 (即時反映)
            if (conditionId === "1" || conditionId === "2") {
                const preview = document.getElementById('preview-2d');
                if(preview) preview.style.backgroundColor = cssColor;
                
                if (conditionId === "2") {
                    document.body.style.backgroundColor = cssColor;
                }
            }

            // VRプレビュー更新
            if (conditionId === "3" || conditionId === "4") {
                const vrPreview = document.getElementById('vr-preview');
                if(vrPreview) vrPreview.setAttribute('material', 'color', cssColor);
                
                const sphere = document.getElementById('env-sphere');
                const grid = document.getElementById('env-grid');
                
                if (conditionId === "4") {
                    if(sphere) sphere.setAttribute('material', 'color', cssColor);
                    if(grid) grid.setAttribute('material', 'color', cssColor);
                } else {
                    if(sphere) sphere.setAttribute('material', 'color', '#808080');
                    if(grid) grid.setAttribute('material', 'color', '#404040'); 
                }
            }
        }

        function hsvToHslCss(h, s, v) {
            s /= 100; v /= 100;
            const l = (2 - s) * v / 2;
            const s_hsl = (l === 0 || l === 1) ? 0 : (s * v) / (l < 0.5 ? (l * 2) : (2 - l * 2));
            return `hsl(${h}, ${Math.round(s_hsl * 100)}%, ${Math.round(l * 100)}%)`;
        }

        // ▼ VR用 (スムージング + ポインター補正)
        AFRAME.registerComponent('color-picker-panel', {
            init: function () {
                this.svPlane = document.querySelector('#sv-plane');
                this.hPlane = document.querySelector('#h-plane');
                this.svCursor = document.querySelector('#sv-cursor');
                this.hCursor = document.querySelector('#h-cursor');
                
                this.svCanvas = document.getElementById('sv-canvas-vr');
                this.svCtx = this.svCanvas.getContext('2d');
                this.hCanvas = document.getElementById('h-canvas-vr');
                this.hCtx = this.hCanvas.getContext('2d');
                
                this.drawH();
                this.drawSV(0);

                this.draggingTarget = null;
                this.raycasterEl = document.querySelector('[raycaster]'); 

                this.targetH = currentH; this.targetS = currentS; this.targetV = currentV;
                this.displayH = currentH; this.displayS = currentS; this.displayV = currentV;

                const startDrag = (evt) => {
                    this.draggingTarget = evt.target;
                    if (evt.detail.intersection) {
                        this.processIntersection(evt.detail.intersection);
                    }
                };
                const stopDrag = () => { this.draggingTarget = null; };

                this.svPlane.addEventListener('mousedown', startDrag);
                this.hPlane.addEventListener('mousedown', startDrag);
                this.el.sceneEl.addEventListener('mouseup', stopDrag);
            },

            tick: function () {
                if (this.draggingTarget && this.raycasterEl) {
                    const raycaster = this.raycasterEl.components.raycaster;
                    const intersection = raycaster.getIntersection(this.draggingTarget);
                    if (intersection) {
                        this.processIntersection(intersection);
                    }
                }

                const factor = 0.1; 
                if (Math.abs(this.targetH - this.displayH) > 0.1) this.displayH += (this.targetH - this.displayH) * factor;
                if (Math.abs(this.targetS - this.displayS) > 0.1) this.displayS += (this.targetS - this.displayS) * factor;
                if (Math.abs(this.targetV - this.displayV) > 0.1) this.displayV += (this.targetV - this.displayV) * factor;

                const newIntH = Math.round(this.displayH);
                const newIntS = Math.round(this.displayS);
                const newIntV = Math.round(this.displayV);

                if (newIntH !== currentH || newIntS !== currentS || newIntV !== currentV) {
                    if (newIntH !== currentH) this.drawSV(newIntH);
                    updateColor(newIntH, newIntS, newIntV);
                }
            },

            processIntersection: function(intersect) {
                const uv = intersect.uv;
                if(isAudioPlayed) operationCount++;
                
                if (intersect.object.el === this.svPlane) {
                    this.targetS = uv.x * 100;
                    this.targetV = uv.y * 100;
                    this.updateCursorVisuals(this.targetH, this.targetS, this.targetV);
                } else if (intersect.object.el === this.hPlane) {
                    this.targetH = uv.x * 360;
                    this.updateCursorVisuals(this.targetH, this.targetS, this.targetV);
                }
            },

            updateCursorVisuals: function(h, s, v) {
                const x_sv = (s / 100 - 0.5) * 0.8;
                const y_sv = (v / 100 - 0.5) * 0.8 + 0.05; 
                this.svCursor.setAttribute('position', { x: x_sv, y: y_sv, z: 0.01 });
                this.svCursor.setAttribute('visible', true);

                const x_h = (h / 360 - 0.5) * 0.8;
                this.hCursor.setAttribute('position', { x: x_h, y: -0.45, z: 0.01 });
                this.hCursor.setAttribute('visible', true);
            },

            drawH: function() {
                const w = this.hCanvas.width, h = this.hCanvas.height;
                const g = this.hCtx.createLinearGradient(0,0,w,0);
                for(let i=0; i<=6; i++) g.addColorStop(i/6, `hsl(${i*60}, 100%, 50%)`);
                this.hCtx.fillStyle = g; this.hCtx.fillRect(0,0,w,h);
                this.updateTexture(this.hPlane);
            },
            drawSV: function(hue) {
                const w = this.svCanvas.width, h = this.svCanvas.height;
                this.svCtx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                this.svCtx.fillRect(0,0,w,h);
                const wg = this.svCtx.createLinearGradient(0,0,w,0);
                wg.addColorStop(0,'white'); wg.addColorStop(1,'rgba(255,255,255,0)');
                this.svCtx.fillStyle = wg; this.svCtx.fillRect(0,0,w,h);
                const bg = this.svCtx.createLinearGradient(0,0,0,h);
                bg.addColorStop(0,'rgba(0,0,0,0)'); bg.addColorStop(1,'black');
                this.svCtx.fillStyle = bg; this.svCtx.fillRect(0,0,w,h);
                this.updateTexture(this.svPlane);
            },
            updateTexture: function(el) {
                const mesh = el.getObject3D('mesh');
                if(mesh && mesh.material && mesh.material.map) mesh.material.map.needsUpdate = true;
            }
        });
    </script>
</body>
</html>
