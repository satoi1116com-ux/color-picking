<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>実験2: デバイス環境比較実験</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7/dist/aframe-extras.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; overflow: hidden; transition: background-color 0.1s; }
        
        /* 2D用UI */
        #ui-2d {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #808080; color: #eee;
            padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 100; display: none; text-align: center;
        }
        
        /* 色相スライダー */
        #h-slider-2d {
            -webkit-appearance: none; appearance: none;
            width: 300px; height: 20px; border-radius: 10px;
            outline: none; margin: 10px 0; border: 1px solid #ccc;
            background: linear-gradient(to right, hsl(0,100%,50%), hsl(60,100%,50%), hsl(120,100%,50%), hsl(180,100%,50%), hsl(240,100%,50%), hsl(300,100%,50%), hsl(360,100%,50%));
        }
        #h-slider-2d::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 24px; height: 24px; border-radius: 50%;
            background: #ffffff; border: 2px solid #333;
            cursor: pointer; box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(184, 184, 184, 0.95); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .hidden { display: none !important; }
        
        canvas { border: 1px solid #ccc; cursor: crosshair; margin-bottom: 10px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin-top: 10px; }
        input, select { padding: 8px; font-size: 16px; margin: 5px; }
        
        #vr-scene-container { width: 100vw; height: 100vh; display: none; }
    </style>
</head>
<body>

    <div id="overlay">
        <div id="setup-screen">
            <h2>実験2: 設定</h2>
            <p>参加者ID: <input type="text" id="participant-id" value="test_user"></p>
            <p>実験条件: 
                <select id="condition-select">
                    <option value="1">条件1: 2D・ピッカーのみ</option>
                    <option value="2">条件2: 2D・全画面</option>
                    <option value="3">条件3: VR・ピッカーのみ</option>
                    <option value="4">条件4: VR・空間全体</option>
                </select>
            </p>
            <p>音声ファイル数: <span id="audio-count">未ロード</span></p>
            
            <div style="margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; background: #f9f9f9;">
                <strong>テストページ</strong><br>
                <button onclick="startPractice()" style="background-color: #ccc; ">練習・音量テストを開始</button>
            </div>
            <br>
            <button onclick="startExperiment()">本番を開始する</button>
        </div>

        <div id="download-screen" class="hidden">
            <h2>実験終了</h2>
            <p>お疲れ様でした。データを保存してください。</p>
            <button onclick="downloadCSV()">結果をダウンロード (CSV)</button>
            <br><br>
            <button onclick="location.reload()">トップに戻る</button>
        </div>
    </div>

    <audio id="audio-player"></audio>

    <div id="ui-2d">
        <h3 id="trial-info-2d">Trial 1</h3>
        <p id="instruction-2d">音を聴いて、想起する色を選んでください</p>
        <button onclick="playCurrentAudio()" id="btn-play-2d">再生 (Play)</button>
        
        <div id="controls-2d" style="margin-top:15px; display:none;">
            <canvas id="sv-canvas-2d" width="300" height="200"></canvas><br>
            <input type="range" id="h-slider-2d" min="0" max="360" value="0" style="width:300px;">
            
            <div style="margin: 10px auto; width: 300px;">
                <p style="margin: 0 0 5px 0; font-size: 14px; color: #eee; text-align: left;">色のプレビュー</p>
                <div id="preview-2d" style="width: 100%; height: 60px; border: 1px solid #eee; border-radius: 5px;"></div>
            </div>
            
            <button onclick="confirmColor()">決定して次へ</button>
        </div>
    </div>

    <div id="vr-scene-container">
        <canvas id="sv-canvas-vr" width="256" height="256" style="display:none;"></canvas>
        <canvas id="h-canvas-vr" width="256" height="64" style="display:none;"></canvas>

        <a-scene id="aframe-scene" embedded>
            <a-sphere id="env-sphere" radius="50" material="shader:flat; color:#808080; side:back" visible="false"></a-sphere>
            <a-grid width="20" height="20" divisions="20" material="shader:flat; color:#404040" position="0 0.01 0"></a-grid>

            <a-entity id="control-panel" position="0 1.3 -1.5" rotation="-15 0 0" color-picker-panel>
                <a-plane position="0 -0.15 -0.01" width="1.1" height="2.2" material="shader:flat; color:#808080"></a-plane>
                
                <a-text id="vr-trial-info" value="Trial 1 / X" align="center" width="3" position="0 1.15 0.05" color="#eee"></a-text>
                <a-text id="vr-message" value="" align="center" width="2" position="0 1.0 0.05" color="#FFFF00"
                        font="https://cdn.jsdelivr.net/gh/etiennepinchon/aframe-fonts/fonts/mplus1p/mplus1p-regular.json" shader="msdf"></a-text>
                
                <a-plane position="0 0.7 0" width="0.8" height="0.2" material="shader:flat; color:#000; opacity:0.5" class="clickable" onclick="playCurrentAudio()">
                    <a-text value="Play Sound" align="center" width="4" position="0 0 0.01"></a-text>
                </a-plane>

                <a-entity id="controls-vr" visible="false">
                    <a-plane id="sv-plane" class="clickable" position="0 0.15 0" width="0.8" height="0.8" material="shader:flat; src:#sv-canvas-vr"></a-plane>
                    <a-sphere id="sv-cursor" position="0 0.15 0.01" radius="0.02" material="shader:flat; color:#FFF" visible="false"></a-sphere>

                    <a-plane id="h-plane" class="clickable" position="0 -0.35 0" width="0.8" height="0.15" material="shader:flat; src:#h-canvas-vr"></a-plane>
                    <a-plane id="h-cursor" position="0 -0.35 0.01" width="0.02" height="0.17" material="shader:flat; color:#FFF; opacity:0.8" visible="false"></a-plane>

                    <a-text value="Preview:" width="3" position="-0.4 -0.5 0" color="#eee"></a-text>
                    <a-plane id="vr-preview" position="0 -0.65 0" width="0.8" height="0.2" material="shader:flat; color:#808080; border-color:#eee"></a-plane>
                    <a-plane position="0 -0.65 -0.005" width="0.82" height="0.22" material="shader:flat; color:#eee"></a-plane>

                    <a-plane position="0 -0.9 0" width="0.8" height="0.2" color="#4CC3D9" class="clickable" onclick="confirmColor()">
                        <a-text value="CONFIRM / NEXT" align="center" width="4" position="0 0 0.01"></a-text>
                    </a-plane>
                </a-entity>
            </a-entity>

            <a-entity id="player" position="0 0 0">
                <a-camera id="camera" look-controls="enabled: true"></a-camera>
                <a-entity laser-controls="hand: right" raycaster="objects: .clickable; far: 5" line="color: red; opacity: 0.75"></a-entity>
            </a-entity>
        </a-scene>
    </div>

    <script>
        // --- 設定エリア ---
        const AUDIO_FILES = [
            "音刺激 ヴァイオリン C.wav", 
            "音刺激 フルート C.wav", 
            "音刺激 単音 C.wav",
            "音刺激 単音 F.wav"
        ];
        
        // 練習用音声ファイル (audioフォルダに入れてください)
        const PRACTICE_AUDIO = "practice.wav";

        const DELAY_MS = 3000; 

        // GAS URL
        const GAS_URL ="https://script.google.com/macros/s/AKfycbwO-b3LMxtAIAf3p-cZbfWNehT56fc5lRnAUJb4dct9eAzdLJWSzXxi20Dgw9YUAEA/exec";
        // ----------------

        let currentTrialIdx = 0;
        let participantId = "";
        let conditionId = "1";
        let results = [];
        let startTime = 0;
        let isAudioPlayed = false;
        let isPracticeMode = false;

        let currentH = 0, currentS = 0, currentV = 100;

        const ui2d = document.getElementById('ui-2d');
        const vrContainer = document.getElementById('vr-scene-container');
        const audioPlayer = document.getElementById('audio-player');
        
        document.getElementById('audio-count').innerText = AUDIO_FILES.length + "ファイル";

        // 練習モード開始
        function startPractice() {
            participantId = document.getElementById('participant-id').value;
            conditionId = document.getElementById('condition-select').value;
            isPracticeMode = true;

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('overlay').classList.add('hidden');

            setupConditionView(conditionId);
            
            // 練習用の画面セットアップ
            currentTrialIdx = -1;
            isAudioPlayed = false;
            
            const infoText = "Practice Mode";
            document.getElementById('trial-info-2d').innerText = infoText;
            document.getElementById('instruction-2d').innerText = "音量を調整し、操作を確認してください";
            
            const vrTrialEl = document.getElementById('vr-trial-info');
            if(vrTrialEl) vrTrialEl.setAttribute('value', "Volume Check / Practice");

            // 練習用音声をロード
            audioPlayer.src = "audio/" + PRACTICE_AUDIO;
            resetTrialState();
            
            showMessage("Adjust Volume & Practice");
        }

        // 本番開始
        function startExperiment() {
            participantId = document.getElementById('participant-id').value;
            conditionId = document.getElementById('condition-select').value;
            isPracticeMode = false;
            
            if(!participantId) { alert("参加者IDを入力してください"); return; }
            
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('overlay').classList.add('hidden');
            
            document.getElementById('instruction-2d').innerText = "音を聴いて、想起する色を選んでください";
            
            setupConditionView(conditionId);
            loadTrial(0);
        }

        function setupConditionView(cond) {
            ui2d.style.display = 'none';
            vrContainer.style.display = 'none';
            document.body.style.backgroundColor = "#808080"; 
            
            if (cond === "1" || cond === "2") {
                ui2d.style.display = 'block';
                init2DCanvas();
            } else {
                vrContainer.style.display = 'block';
                const sphere = document.getElementById('env-sphere');
                sphere.setAttribute('visible', true);
                sphere.setAttribute('material', 'color', '#808080'); 
            }
        }

        function loadTrial(index) {
            if (index >= AUDIO_FILES.length) {
                finishExperiment();
                return;
            }
            currentTrialIdx = index;
            isAudioPlayed = false;
            
            const trialText = `Trial ${index + 1} / ${AUDIO_FILES.length}`;
            const audioName = AUDIO_FILES[index];
            
            document.getElementById('trial-info-2d').innerText = trialText;
            
            const vrTrialEl = document.getElementById('vr-trial-info');
            if(vrTrialEl) vrTrialEl.setAttribute('value', trialText);

            audioPlayer.src = "audio/" + audioName; 
            
            resetTrialState();
            console.log(`Trial ${index+1} loaded: ${audioName}`);
        }

        function resetTrialState() {
            currentH = 0; currentS = 0; currentV = 50;
            updateColor(currentH, currentS, currentV);

            document.getElementById('controls-2d').style.display = 'none';
            const vrControls = document.getElementById('controls-vr');
            if(vrControls) vrControls.setAttribute('visible', false);
            
            const slider = document.getElementById('h-slider-2d');
            if(slider) slider.value = 0;
            if (conditionId === "1" || conditionId === "2") init2DCanvas();
        }

        function playCurrentAudio() {
            audioPlayer.play().then(() => {
                if(!isAudioPlayed) {
                    isAudioPlayed = true;
                    showMessage("Listening...");
                    
                    setTimeout(() => {
                        startTime = Date.now();
                        showMessage(""); 
                        document.getElementById('controls-2d').style.display = 'block';
                        const vrControls = document.getElementById('controls-vr');
                        if(vrControls) vrControls.setAttribute('visible', true);
                    }, DELAY_MS);
                }
            }).catch(e => showMessage("Error: Audio not found"));
        }

        function showMessage(text) {
            console.log("Message:", text);
            if (conditionId === "3" || conditionId === "4") {
                const msgEl = document.getElementById('vr-message');
                if (msgEl) {
                    msgEl.setAttribute('value', text);
                    if(text !== "Listening...") {
                        setTimeout(() => { msgEl.setAttribute('value', ""); }, 3000);
                    }
                }
            } else {
                // 2Dではコンソールのみ、または必要なら表示
            }
        }

        function confirmColor() {
            if (!isAudioPlayed) {
                showMessage("Please play sound first!");
                return;
            }

            // ★ 練習モードの場合の処理 (修正済み)
            if (isPracticeMode) {
                console.log("Practice finished. Returning to menu...");
                showMessage("Practice Done. Returning...");
                
                // 1.5秒後にメニューに戻す
                setTimeout(() => {
                    // UIを隠す
                    document.getElementById('ui-2d').style.display = 'none';
                    document.getElementById('vr-scene-container').style.display = 'none';
                    
                    // 背景を白に戻す（setup画面用）
                    document.body.style.backgroundColor = "#FFFFFF"; 
                    
                    // オーバーレイ（メニュー）を再表示
                    document.getElementById('overlay').classList.remove('hidden');
                    document.getElementById('setup-screen').classList.remove('hidden');
                    
                    // 練習フラグをリセット
                    isPracticeMode = false;
                    
                }, 1500);
                return;
            }

            // 本番データの記録
            const rt = Date.now() - startTime;
            const hsl = hsvToHslCss(currentH, currentS, currentV);
            const record = {
                participant_id: participantId,
                condition: conditionId,
                trial_number: currentTrialIdx + 1,
                audio_file: AUDIO_FILES[currentTrialIdx],
                h: currentH, s: currentS, v: currentV,
                hsl_css: hsl,
                reaction_time_ms: rt,
                timestamp: new Date().toISOString()
            };
            
            // GASへ送信
            sendToGoogleSheets(record);

            showMessage("Recorded! Next trial...");
            results.push(record);
            loadTrial(currentTrialIdx + 1);
        }

        function sendToGoogleSheets(data) {
            fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(data)
            }).then(() => {
                console.log("Data sent to Google Sheets");
            }).catch(err => {
                console.error("Failed to send data:", err);
            });
        }

        function finishExperiment() {
            document.getElementById('overlay').classList.remove('hidden');
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('download-screen').classList.remove('hidden');
            vrContainer.style.display = 'none';
        }

        function downloadCSV() {
            if (results.length === 0) return;
            const headers = Object.keys(results[0]).join(",");
            const rows = results.map(r => Object.values(r).join(","));
            const csvContent = headers + "\n" + rows.join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `exp2_${participantId}_cond${conditionId}.csv`;
            a.click();
        }

        function updateColor(h, s, v) {
            currentH = h; currentS = s; currentV = v;
            const cssColor = hsvToHslCss(h, s, v);

            if (conditionId === "1") {
                document.getElementById('preview-2d').style.backgroundColor = cssColor;
            } else if (conditionId === "2") {
                document.getElementById('preview-2d').style.backgroundColor = cssColor;
                document.body.style.backgroundColor = cssColor;
            }

            if (conditionId === "3" || conditionId === "4") {
                const vrPreview = document.getElementById('vr-preview');
                if(vrPreview) vrPreview.setAttribute('material', 'color', cssColor);
                
                if (conditionId === "4") {
                    const sphere = document.getElementById('env-sphere');
                    if(sphere) sphere.setAttribute('material', 'color', cssColor);
                } else {
                    const sphere = document.getElementById('env-sphere');
                    if(sphere) sphere.setAttribute('material', 'color', '#808080');
                }
            }
        }

        function hsvToHslCss(h, s, v) {
            s /= 100; v /= 100;
            const l = (2 - s) * v / 2;
            const s_hsl = (l === 0 || l === 1) ? 0 : (s * v) / (l < 0.5 ? (l * 2) : (2 - l * 2));
            return `hsl(${h}, ${Math.round(s_hsl * 100)}%, ${Math.round(l * 100)}%)`;
        }

        function init2DCanvas() {
            const canvas = document.getElementById('sv-canvas-2d');
            const ctx = canvas.getContext('2d');
            const slider = document.getElementById('h-slider-2d');

            function drawSV() {
                const w = canvas.width, h = canvas.height;
                ctx.fillStyle = `hsl(${slider.value}, 100%, 50%)`;
                ctx.fillRect(0,0,w,h);
                const wg = ctx.createLinearGradient(0,0,w,0);
                wg.addColorStop(0,'white'); wg.addColorStop(1,'rgba(255,255,255,0)');
                ctx.fillStyle = wg; ctx.fillRect(0,0,w,h);
                const bg = ctx.createLinearGradient(0,0,0,h);
                bg.addColorStop(0,'rgba(0,0,0,0)'); bg.addColorStop(1,'black');
                ctx.fillStyle = bg; ctx.fillRect(0,0,w,h);
            }
            slider.addEventListener('input', () => { drawSV(); updateColor(slider.value, currentS, currentV); });
            let dragging = false;
            const pick = (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
                const y = Math.max(0, Math.min(e.clientY - rect.top, rect.height));
                const s = Math.round((x / rect.width) * 100);
                const v = Math.round((1 - y / rect.height) * 100);
                updateColor(slider.value, s, v);
            };
            canvas.addEventListener('mousedown', (e) => { dragging = true; pick(e); });
            window.addEventListener('mousemove', (e) => { if(dragging) pick(e); });
            window.addEventListener('mouseup', () => dragging = false);
            drawSV();
        }

        AFRAME.registerComponent('color-picker-panel', {
            init: function () {
                this.svPlane = document.querySelector('#sv-plane');
                this.hPlane = document.querySelector('#h-plane');
                this.svCursor = document.querySelector('#sv-cursor');
                this.hCursor = document.querySelector('#h-cursor');
                
                this.svCanvas = document.getElementById('sv-canvas-vr');
                this.svCtx = this.svCanvas.getContext('2d');
                this.hCanvas = document.getElementById('h-canvas-vr');
                this.hCtx = this.hCanvas.getContext('2d');
                
                this.drawH();
                this.drawSV(0);

                this.el.sceneEl.addEventListener('click', (evt) => {
                    const intersect = evt.detail.intersection;
                    if (!intersect) return;
                    
                    if (intersect.object.el === this.svPlane) {
                        const uv = intersect.uv;
                        const s = Math.round(uv.x * 100);
                        const v = Math.round(uv.y * 100);
                        this.svCursor.setAttribute('position', { x: (uv.x - 0.5) * 0.8, y: (uv.y - 0.5) * 0.8 + 0.15, z: 0.01 });
                        this.svCursor.setAttribute('visible', true);
                        updateColor(currentH, s, v);

                    } else if (intersect.object.el === this.hPlane) {
                        const uv = intersect.uv;
                        const h = Math.round(uv.x * 360);
                        this.hCursor.setAttribute('position', { x: (uv.x - 0.5) * 0.8, y: -0.35, z: 0.01 });
                        this.hCursor.setAttribute('visible', true);
                        this.drawSV(h);
                        updateColor(h, currentS, currentV);
                    }
                });
            },
            drawH: function() {
                const w = this.hCanvas.width, h = this.hCanvas.height;
                const g = this.hCtx.createLinearGradient(0,0,w,0);
                for(let i=0; i<=6; i++) g.addColorStop(i/6, `hsl(${i*60}, 100%, 50%)`);
                this.hCtx.fillStyle = g; this.hCtx.fillRect(0,0,w,h);
                this.updateTexture(this.hPlane);
            },
            drawSV: function(hue) {
                const w = this.svCanvas.width, h = this.svCanvas.height;
                this.svCtx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                this.svCtx.fillRect(0,0,w,h);
                const wg = this.svCtx.createLinearGradient(0,0,w,0);
                wg.addColorStop(0,'white'); wg.addColorStop(1,'rgba(255,255,255,0)');
                this.svCtx.fillStyle = wg; this.svCtx.fillRect(0,0,w,h);
                const bg = this.svCtx.createLinearGradient(0,0,0,h);
                bg.addColorStop(0,'rgba(0,0,0,0)'); bg.addColorStop(1,'black');
                this.svCtx.fillStyle = bg; this.svCtx.fillRect(0,0,w,h);
                this.updateTexture(this.svPlane);
            },
            updateTexture: function(el) {
                const mesh = el.getObject3D('mesh');
                if(mesh && mesh.material && mesh.material.map) mesh.material.map.needsUpdate = true;
            }
        });
    </script>
</body>
</html>
